# Global option declarations
option dhcp-client-architecture code 93 = unsigned integer 16;
option space ipxe;
option ipxe-encap-opts code 175 = encapsulate ipxe;
option ipxe.priority code 1 = signed integer 8;
option space BSDP; #optional
option BSDP.server_identifier code 68 = unsigned integer 32; #optional
"option BSDP.server_identifier {{ SERVER_IP | ansible.utils.ip4_hex | int(base=16) }}";

default-lease-time 3600;
max-lease-time 86400;
authoritative;

option domain-name "pxe.local";
"option domain-name-servers {{ DNS_SERVER }};"

# Subnet declarations
"subnet {{ SUBNET }} netmask {{ NETMASK }} {"
  "range {{ DHCP_RANGE_START }} {{ DHCP_RANGE_END }};"
  "option routers {{ GATEWAY_IP }};"
  "option subnet-mask {{ NETMASK }};"
  "next-server {{ SERVER_IP }};"

  # PXE boot logic:
  
  # Match non-UEFI BIOS clients (no Arch field)
  if substring(option vendor-class-identifier, 0, 9) = "PXEClient" {
    filename "undionly.kpxe";
  }

  # Match iPXE clients using Vendor Class Identifier
  if substring(option vendor-class-identifier, 0, 4) = "iPXE" {
    "filename "{{ SERVER_IP }}/ipxe.menu";"
  }

  # UEFI 32-bit clients
  if substring(option vendor-class-identifier, 15, 5) = "00006" {
    filename "snponly_32bit.efi";
  }

  # UEFI 64-bit clients
  if substring(option vendor-class-identifier, 15, 5) = "00007" {
    filename "snponly_64bit.efi";
  }

  # UEFI HTTP clients
  if substring(option vendor-class-identifier, 15, 5) = "00009" {
    filename "snponly_64bit.efi";
  }

  class "Apple-Intel-Netboot" {
    match if substring (option vendor-class-identifier, 0, 14) = "AAPLBSDPC/i386";
    option dhcp-parameter-request-list 1,3,17,43,60;
    if (option dhcp-message-type = 8) {
        option vendor-class-identifier "AAPLBSDPC";
        if (substring(option vendor-encapsulated-options, 0, 3) = 01:01:01) {
            # BSDP List
            option vendor-encapsulated-options 01:01:01:04:02:80:00:07:04:81:00:05:2a:09:0D:81:00:05:2a:08:69:50:58:45:2D:42:44:45;
        }
        elsif (substring(option vendor-encapsulated-options, 0, 3) = 01:01:02) {
            # BSDP Select
            option vendor-encapsulated-options 01:01:02:08:04:81:00:05:2a:82:0a:4e:65:74:42:6f:6f:74:30:30:31;
            filename "snponly_64bit.efi";
            "next-server {{ SERVER_IP }};"
        }
    }
  }
}
